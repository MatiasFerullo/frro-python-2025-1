<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Cartera de Futuros</title>
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='favicon-96x96.png') }}"
      sizes="96x96"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='favicon.svg') }}"
    />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ url_for('static', filename='apple-touch-icon.png') }}"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='site.webmanifest') }}"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="{{ url_for('static', filename='css/output.css') }}"
    />
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    <script>
      function formatPrice(value) {
        let isInt = Number.isInteger(value);
        let formatted;
        if (isInt) {
          formatted = value.toLocaleString("de-DE");
        } else {
          formatted = value.toLocaleString("de-DE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        }
        return formatted.replace(/\./g, ".").replace(",", ",");
      }

      async function initChart() {
        const stockChart = document
          .getElementById("stockChart")
          .getContext("2d");

        const chart1DataResponse = await fetch("/portfolio-chart-data");
        const chart1Data = await chart1DataResponse.json();

        let chart1 = new Chart(stockChart, {
          type: "line",
          data: {
            // prettier-ignore
            labels: chart1Data.labels,
            datasets: [
              {
                data: chart1Data.values,
                borderColor: "oklch(37.2% 0.044 257.287)",
                backgroundColor: "oklch(55.4% 0.046 257.417 / 50%)",
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
            scales: {
              x: {
                title: { display: false },
                grid: { display: false },
              },
              y: {
                title: { display: false },
                grid: { display: false },
              },
            },
          },
        });

        const compositionChart = document
          .getElementById("compositionChart")
          .getContext("2d");

        const chart2DataResponse = await fetch(
          "/portfolio-composition-chart-data",
        );
        const chart2Data = await chart2DataResponse.json();

        let tooltipsEnabled = true;

        if (chart2Data.values.length === 0) {
          chart2Data.labels = ["Portfolio vacío"];
          chart2Data.values = [1];
          chart2Data.backgroundColor = ["#d1d5db"];
          tooltipsEnabled = false;
        }

        const chart2 = new Chart(compositionChart, {
          type: "doughnut",
          data: {
            labels: chart2Data.labels,
            datasets: [
              {
                data: chart2Data.values,
                borderWidth: 0,
                ...(chart2Data.backgroundColor && {
                  backgroundColor: chart2Data.backgroundColor,
                  hoverBackgroundColor: chart2Data.backgroundColor,
                }),
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: tooltipsEnabled,
                callbacks: {
                  label: function (context) {
                    return "$" + formatPrice(context.parsed);
                  },
                },
              },
            },
          },
        });
      }

      if (document.startViewTransition) {
        document
          .startViewTransition(() => {})
          .finished.then(() => {
            initChart();
          });
      } else {
        document.addEventListener("DOMContentLoaded", initChart);
      }
    </script>
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
    <script type="module">
      import { DotLottie } from "{{ url_for('static', filename='js/lottie.js') }}";
      const iconAnim = new DotLottie({
        autoplay: true,
        canvas: document.getElementById("icon"),
        src: "{{ url_for('static', filename='icon.json') }}",
      });
      const homeBtn = document.getElementById("homeBtn");
      homeBtn.addEventListener("mouseenter", () => iconAnim.play());
      homeBtn.addEventListener("touchstart", () => iconAnim.play());
    </script>
    <style>
      @view-transition {
        navigation: auto; /**/
      }
      /* prettier-ignore */
      ::view-transition-group(alerts-bar) { z-index: 2; }
      /* prettier-ignore */
      ::view-transition-group(alerts-title) { z-index: 2; }
      /* prettier-ignore */
      ::view-transition-group(alerts-content) { z-index: 2; }
      /* prettier-ignore */
      ::view-transition-group(portfolio-bar) { z-index: 2; }
      /* prettier-ignore */
      ::view-transition-group(portfolio-title) { z-index: 2; }
      /* prettier-ignore */
      ::view-transition-group(portfolio-content) { z-index: 2; }
    </style>
  </head>
  <body class="overflow-x-hidden bg-[#fbfbfb] select-none">
    <div class="flex justify-center border-b-1 border-slate-200 bg-white">
      <div
        class="flex w-full max-w-4xl flex-row items-center justify-between p-2"
      >
        <div>
          <a
            id="homeBtn"
            href="/"
            class="flex cursor-pointer rounded-sm font-semibold transition hover:bg-gray-200 active:scale-90 active:bg-gray-200"
          >
            <div class="flex flex-row items-center gap-2">
              <canvas
                id="icon"
                width="40"
                height="40"
                class="h-10 w-10"
              ></canvas>
              <p class="mr-1 hidden sm:block">Cartera de Futuros</p>
            </div>
          </a>
        </div>
        <div>
          <form action="/auth/logout" method="POST">
            <button
              type="submit"
              class="flex cursor-pointer rounded-sm p-1 transition hover:bg-gray-200 active:scale-90 active:bg-gray-200"
            >
              Cerrar sesión
            </button>
          </form>
        </div>
      </div>
    </div>
    <div
      class="flex w-full justify-center border-b-1 border-slate-200 bg-white"
    >
      <div
        class="flex w-full max-w-4xl flex-col items-start gap-2 p-4 sm:flex-row sm:items-center sm:gap-4 lg:p-6"
      >
        <div
          hx-get="/get-portfolio-summary"
          hx-trigger="load"
          hx-swap="innerHTML"
        >
          <div
            class="flex animate-pulse flex-col gap-1 rounded-sm bg-gray-200"
            id="summary-loading"
          >
            <div class="flex flex-row items-end gap-1">
              <h1 class="text-3xl font-semibold text-transparent">$0.000,0</h1>
              <span class="text-2xl text-transparent">ARS</span>
            </div>
            <div class="flex gap-2">
              <div class="flex flex-row gap-1">
                <p class="font-semibold text-transparent">+$00,0</p>
                <p class="text-transparent">ARS</p>
              </div>
              <div class="flex flex-row items-center gap-1 px-2">
                <p class="font-semibold text-transparent">0,0%</p>
              </div>
            </div>
          </div>
        </div>
        <a
          class="flex h-40 w-full min-w-0 cursor-pointer rounded-sm bg-white transition hover:bg-gray-200 active:scale-90 active:bg-gray-200 sm:flex-1"
          style="view-transition-name: chart"
          href="/chart"
        >
          <canvas id="stockChart"></canvas>
        </a>
      </div>
    </div>
    <div class="flex min-h-screen w-full flex-col items-center">
      <div
        class="w-full flex-1 items-center border-slate-200 bg-white lg:max-w-4xl lg:border-x-1"
      >
        <div
          class="flex items-center justify-between border-b-1 border-slate-200 bg-white p-4 lg:px-6 lg:pt-6"
          style="view-transition-name: alerts-bar"
        >
          <h2
            class="text-xl leading-none sm:text-2xl"
            style="view-transition-name: alerts-title"
          >
            Alertas
          </h2>
          <a
            class="flex cursor-pointer rounded-sm bg-slate-600 p-1 text-white transition active:scale-90"
            href="/alerts"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"
              />
              <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
            </svg>
          </a>
        </div>
        <div style="view-transition-name: alerts-content"></div>
        <div
          class="flex items-center justify-between bg-white p-4 lg:px-6 lg:pt-6"
          style="view-transition-name: portfolio-bar"
        >
          <h2
            class="text-xl leading-none sm:text-2xl"
            style="view-transition-name: portfolio-title"
          >
            Portafolio
          </h2>
          <a
            class="flex cursor-pointer rounded-sm bg-slate-600 p-1 text-white transition active:scale-90"
            href="/portfolio"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4"
              />
              <path d="M13.5 6.5l4 4" />
            </svg>
          </a>
        </div>
        <div style="view-transition-name: portfolio-content"></div>
        <div class="px-4 lg:px-6">
          <div
            class="divide-y divide-gray-200"
            hx-get="/get-user-stocks?view=menu"
            hx-trigger="load"
            hx-swap="innerHTML"
            id="stock-list"
          >
            <div>
              <button
                class="flex w-full animate-pulse rounded-sm bg-gray-200 p-1 text-transparent"
              >
                <div class="flex w-full flex-row justify-between">
                  <div class="flex flex-col items-start">
                    <h3 class="font-semibold">NONE</h3>
                    <p>NONE</p>
                  </div>
                  <div class="flex flex-col items-end">
                    <h3 class="font-semibold">NONE</h3>
                    <div
                      class="flex flex-row items-center gap-1 rounded-full px-2"
                    >
                      <p class="font-semibold">NONE</p>
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
        <div
          class="flex items-center justify-between bg-white p-4 lg:px-6 lg:pt-6"
        >
          <h2 class="text-xl leading-none sm:text-2xl">Composición</h2>
        </div>
        <div class="px-4 lg:px-6">
          <div class="flex h-70 justify-center">
            <canvas id="compositionChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
