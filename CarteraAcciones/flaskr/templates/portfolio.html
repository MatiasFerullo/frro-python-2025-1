<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Cartera de Futuros</title>
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='favicon-96x96.png') }}"
      sizes="96x96"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='favicon.svg') }}"
    />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ url_for('static', filename='apple-touch-icon.png') }}"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='site.webmanifest') }}"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="{{ url_for('static', filename='css/output.css') }}"
    />
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
    <style>
      @view-transition {
        navigation: auto; /**/
      }
    </style>
  </head>
  <body class="overflow-x-hidden bg-[#fbfbfb] select-none">
    <div class="flex min-h-screen w-full flex-col items-center">
      <div
        class="w-full flex-1 items-center border-slate-200 bg-white lg:max-w-4xl lg:border-x-1"
      >
        <!-- Portfolio -->
        <div id="portfolio-view">
          <div
            class="flex flex-row items-center gap-2 bg-white p-4 lg:px-6 lg:pt-6"
            style="view-transition-name: portfolio-bar"
          >
            <a
              class="flex cursor-pointer rounded-sm p-1 text-gray-400 transition hover:bg-gray-200 active:scale-90 active:bg-gray-200"
              href="/"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M15 6l-6 6l6 6" />
              </svg>
            </a>
            <h1
              class="text-xl leading-none sm:text-2xl"
              style="view-transition-name: portfolio-title"
            >
              Portafolio
            </h1>
          </div>
          <div
            class="px-4 pb-4 lg:px-6 lg:pb-6"
            style="view-transition-name: portfolio-content"
          >
            <div
              class="divide-y divide-gray-200"
              hx-get="/get-user-stocks?view=edit"
              hx-trigger="load"
              hx-swap="innerHTML"
              id="stock-list"
            >
              <div
                class="flex w-full animate-pulse rounded-sm bg-gray-200 p-1 text-transparent"
              >
                <div class="flex w-full flex-row justify-between">
                  <div class="flex w-full flex-col items-start">
                    <h3 class="font-semibold">NONE/NONE/NONE</h3>
                    <div class="flex flex-row items-center gap-1">
                      <p>00.0 x $0000.0 ARS</p>
                    </div>
                  </div>
                  <div class="flex flex-row items-center gap-2">
                    <div class="flex p-1">
                      <div class="h-[24px] w-[24px]"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div data-anim-name="stock-form-content" id="stock-form-content">
              <button
                class="mt-4 flex w-full cursor-pointer justify-center rounded-sm bg-slate-600 px-3 py-2 text-white transition active:scale-90"
                data-anim-name="stock-form-bar"
                onclick="openPopup('add')"
              >
                <div class="flex flex-row justify-center gap-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    data-anim-name="stock-form-back"
                    id="stock-form-back"
                  >
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M12 5l0 14" />
                    <path d="M5 12l14 0" />
                  </svg>
                  <label
                    class="cursor-pointer"
                    data-anim-name="stock-form-title"
                    id="stock-form-title"
                    >Añadir futuro</label
                  >
                </div>
              </button>
            </div>
          </div>
        </div>
        <!-- Stock form -->
        <div hidden id="stock-form-view">
          <div
            class="flex flex-row items-center gap-2 bg-white p-4 lg:px-6 lg:pt-6"
            style="view-transition-name: stock-form-bar"
          >
            <button
              id="stock-form-back-btn"
              class="flex cursor-pointer rounded-sm p-1 text-gray-400 transition hover:bg-gray-200 active:scale-90 active:bg-gray-200"
              style="view-transition-name: stock-form-back"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M18 6l-12 12" />
                <path d="M6 6l12 12" />
              </svg>
            </button>
            <h1
              class="text-xl leading-none sm:text-2xl"
              style="view-transition-name: stock-form-title"
            >
              Añadir futuro
            </h1>
          </div>
          <div
            class="px-4 pb-4 lg:px-6 lg:pb-6"
            style="view-transition-name: stock-form-content"
          >
            <form
              class="px-[2px]"
              hx-post="/new-portfolio-stock"
              hx-swap="innerHTML"
              hx-target="#stock-list"
              onsubmit="history.back()"
            >
              <p class="mb-4 flex flex-col">
                <label class="mb-1 text-slate-500" for="stock"
                  >Nombre del futuro</label
                >
                <select
                  class="rounded-sm px-3 py-2 outline-1 outline-slate-200 transition placeholder:text-slate-500 focus:outline-slate-300"
                  id="stock"
                  name="accion_id"
                  required
                  hx-get="/get-available-stocks"
                  hx-trigger="load"
                  hx-swap="innerHTML"
                  hx-target="this"
                ></select>
              </p>
              <p class="mb-4 flex flex-col">
                <label class="mb-1 text-slate-500" for="amount">Cantidad</label>
                <input
                  class="rounded-sm px-3 py-2 outline-1 outline-slate-200 transition placeholder:text-slate-500 focus:outline-slate-300"
                  type="number"
                  id="amount"
                  min="1"
                  step="1"
                  name="cantidad"
                  value="1"
                  required
                />
              </p>
              <p class="mb-4 flex flex-col">
                <label class="mb-1 text-slate-500" for="date">Fecha</label>
                <input
                  class="w-full rounded-sm px-3 py-2 outline-1 outline-slate-200 transition placeholder:text-slate-500 focus:outline-slate-300"
                  type="date"
                  id="date"
                  name="fecha"
                  value=""
                  required
                />
                <script>
                  const now = new Date();
                  const formattedDate = now.toISOString().split("T")[0];
                  const dateInput = document.getElementById("date");
                  dateInput.value = formattedDate;
                  dateInput.max = formattedDate;
                </script>
              </p>
              <button
                class="mt-4 w-full cursor-pointer rounded-sm bg-slate-600 px-3 py-2 text-white transition active:scale-90"
                type="submit"
              >
                Guardar
              </button>
            </form>
          </div>
        </div>
        <!-- Edit stock form -->
        <div hidden id="edit-stock-form-view">
          <div
            class="flex flex-row items-center gap-2 bg-white p-4 lg:px-6 lg:pt-6"
            id="edit-stock-form-bar"
            style="view-transition-name: edit-stock-form-bar"
          >
            <button
              id="edit-stock-form-back-btn"
              class="flex cursor-pointer rounded-sm p-1 text-gray-400 transition hover:bg-gray-200 active:scale-90 active:bg-gray-200"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M18 6l-12 12" />
                <path d="M6 6l12 12" />
              </svg>
            </button>
            <h1 class="text-xl leading-none sm:text-2xl">Editar futuro</h1>
          </div>
          <div
            class="px-4 pb-4 lg:px-6 lg:pb-6"
            id="edit-stock-form-content"
            style="view-transition-name: edit-stock-form-content"
          >
            <form
              class="px-[2px]"
              hx-patch="/edit-portfolio-stock"
              hx-swap="innerHTML"
              hx-target="#stock-list"
              onsubmit="history.back()"
            >
              <input
                type="hidden"
                name="usuario_accion_id"
                id="edit-user-stock-id"
              />
              <div class="mb-4 flex flex-col">
                <p class="mb-1 text-slate-500">Nombre del futuro</p>
                <div
                  class="flex items-start rounded-sm px-3 py-2 outline-1 outline-slate-200 transition placeholder:text-slate-500 focus:outline-slate-300"
                  id="edit-stock"
                >
                  <h3
                    class="font-semibold text-slate-500"
                    id="edit-stock-form-symbol"
                    style="view-transition-name: edit-stock-form-symbol"
                  >
                    BLANK
                  </h3>
                </div>
              </div>
              <p class="mb-4 flex flex-col">
                <label class="mb-1 text-slate-500" for="edit-amount"
                  >Cantidad</label
                >
                <input
                  class="rounded-sm px-3 py-2 outline-1 outline-slate-200 transition placeholder:text-slate-500 focus:outline-slate-300"
                  type="number"
                  id="edit-amount"
                  min="1"
                  step="1"
                  name="cantidad"
                  value="1"
                  required
                />
              </p>
              <p class="mb-4 flex flex-col">
                <label class="mb-1 text-slate-500" for="edit-date">Fecha</label>
                <input
                  class="w-full rounded-sm px-3 py-2 outline-1 outline-slate-200 transition placeholder:text-slate-500 focus:outline-slate-300"
                  type="date"
                  id="edit-date"
                  name="fecha"
                  value=""
                  required
                />
              </p>
              <button
                class="mt-4 w-full cursor-pointer rounded-sm bg-slate-600 px-3 py-2 text-white transition active:scale-90"
                type="submit"
              >
                Guardar
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script>
      const portfolioView = document.getElementById("portfolio-view");
      const stockFormView = document.getElementById("stock-form-view");
      const editStockFormView = document.getElementById("edit-stock-form-view");
      const backButton = document.getElementById("stock-form-back-btn");
      const editBackButton = document.getElementById(
        "edit-stock-form-back-btn",
      );

      let isPopupOpen = false;
      let currentPopup = null; // 'add' | 'edit'

      const getAnimElements = () =>
        document.querySelectorAll("[data-anim-name]");

      const applyViewTransitionNames = () =>
        getAnimElements().forEach(
          (el) => (el.style.viewTransitionName = el.dataset.animName),
        );

      const removeViewTransitionNames = () =>
        getAnimElements().forEach((el) => (el.style.viewTransitionName = ""));

      const toggleViews = async (targetView) => {
        if (!document.startViewTransition) {
          portfolioView.hidden = true;
          stockFormView.hidden = true;
          editStockFormView.hidden = true;
          targetView.hidden = false;
          return;
        }

        const transition = document.startViewTransition(() => {
          portfolioView.hidden = true;
          stockFormView.hidden = true;
          editStockFormView.hidden = true;
          targetView.hidden = false;
        });

        await transition.finished;
        removeViewTransitionNames();
      };

      const openPopup = async (type) => {
        if (isPopupOpen) return;

        isPopupOpen = true;
        currentPopup = type;
        applyViewTransitionNames();

        history.pushState({ popup: type }, "", "");

        const targetView = type === "edit" ? editStockFormView : stockFormView;
        await toggleViews(targetView);
      };

      const openEditPopup = async (id, symbol, amount, date, price) => {
        // Animated elements
        const editSymbol = document.getElementById("edit-stock-form-symbol");
        const editContent = document.getElementById("edit-stock-form-content");
        const editBar = document.getElementById("edit-stock-form-bar");

        // Form fields
        const editUserStockId = document.getElementById("edit-user-stock-id");
        const editAmount = document.getElementById("edit-amount");
        const editDate = document.getElementById("edit-date");

        editUserStockId.value = id;
        editSymbol.style.viewTransitionName = `edit-stock-form-symbol-${id}`;
        editContent.style.viewTransitionName = `edit-stock-form-content-${id}`;
        editBar.style.viewTransitionName = `edit-stock-form-bar-${id}`;

        editSymbol.textContent = symbol;
        editAmount.value = amount;
        editDate.value = date;

        await openPopup("edit");
      };

      const closePopup = async () => {
        if (!isPopupOpen) return;

        isPopupOpen = false;
        currentPopup = null;
        applyViewTransitionNames();
        await toggleViews(portfolioView);
      };

      window.addEventListener("popstate", async (event) => {
        if (isPopupOpen) {
          await closePopup();
        }
      });

      backButton.addEventListener("click", async () => {
        history.back();
      });

      editBackButton.addEventListener("click", async () => {
        history.back();
      });
    </script>
    <script>
      if (!window.errorListenerRegistered) {
        document.body.addEventListener("showError", function (evt) {
          alert(evt.detail.value);
        });
        window.errorListenerRegistered = true;
      }
    </script>
  </body>
</html>
